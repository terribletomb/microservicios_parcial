name: CI/CD Microservicios Golang

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [ "main" ]

jobs:

  # ============================
  # 1. PRUEBAS UNITARIAS E INTEGRACIÓN
  # ============================
  tests:
    name: Ejecutar pruebas
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Ejecutar pruebas con cobertura
        run: |
          go test ./... -coverprofile=coverage.out
          go tool cover -func=coverage.out

      - name: Guardar cobertura como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: cobertura
          path: coverage.out

  # ============================
  # 2. CONSTRUCCIÓN DE IMÁGENES CON BUILDX
  # ============================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login a DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login a GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Construir imágenes de los microservicios
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USER }}/create-service:latest ./services/create-service
          docker build -t ${{ secrets.DOCKERHUB_USER }}/read-service:latest ./services/read-service
          docker build -t ${{ secrets.DOCKERHUB_USER }}/update-service:latest ./services/update-service
          docker build -t ${{ secrets.DOCKERHUB_USER }}/delete-service:latest ./services/delete-service

  # ============================
  # 3. ESCANEO DE SEGURIDAD CON TRIVY
  # ============================
  security_scan:
    name: Escaneo con Trivy
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Descargar imágenes
        run: |
          docker pull ${{ secrets.DOCKERHUB_USER }}/create-service:latest
          docker pull ${{ secrets.DOCKERHUB_USER }}/read-service:latest
          docker pull ${{ secrets.DOCKERHUB_USER }}/update-service:latest
          docker pull ${{ secrets.DOCKERHUB_USER }}/delete-service:latest

      - name: Ejecutar Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USER }}/create-service:latest
          format: "table"
          exit-code: "0"

  # ============================
  # 4. PUSH A DOCKERHUB + GHCR
  # ============================
  push_images:
    name: Push de imágenes
    runs-on: ubuntu-latest
    needs: [build, security_scan]

    steps:
      - uses: actions/checkout@v4

      - name: Login DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push de imágenes
        run: |
          docker push ${{ secrets.DOCKERHUB_USER }}/create-service:latest
          docker push ${{ secrets.DOCKERHUB_USER }}/read-service:latest
          docker push ${{ secrets.DOCKERHUB_USER }}/update-service:latest
          docker push ${{ secrets.DOCKERHUB_USER }}/delete-service:latest

  # ============================
  # 5. RELEASE AUTOMÁTICO AL CREAR TAG
  # ============================
  release:
    name: Crear Release
    runs-on: ubuntu-latest
    needs: push_images
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Crear Release en GitHub
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          

